
const admin = require('firebase-admin');
const serviceAccount = require('../lilymagerp-fs1-firebase-adminsdk-fbsvc-a55fb8f1d5.json');

if (!admin.apps.length) {
    admin.initializeApp({
        credential: admin.credential.cert(serviceAccount)
    });
}

const db = admin.firestore();

async function syncOutsourceToExpenses() {
    console.log('Fetching outsourced orders...');
    const ordersSnapshot = await db.collection('orders')
        .where('outsourceInfo.isOutsourced', '==', true)
        .get();

    console.log(`Found ${ordersSnapshot.size} outsourced orders.`);

    const expensesSnapshot = await db.collection('simpleExpenses')
        .where('description', '>=', '외부발주:')
        .get();

    const existingOutsourceDescriptions = new Set();
    expensesSnapshot.forEach(doc => {
        existingOutsourceDescriptions.add(doc.data().description);
    });

    console.log(`Found ${existingOutsourceDescriptions.size} existing outsource expenses.`);

    let addedCount = 0;
    for (const orderDoc of ordersSnapshot.docs) {
        const order = orderDoc.data();
        const itemsDescription = (order.items || []).map(item => `${item.name}(${item.quantity})`).join(', ');
        const description = `외부발주: ${itemsDescription}`;
        const partnerPrice = order.outsourceInfo.partnerPrice || 0;
        const totalQuantity = (order.items || []).reduce((sum, item) => sum + (item.quantity || 0), 0);

        if (!existingOutsourceDescriptions.has(description)) {
            console.log(`Registering expense for order ${order.orderNumber || orderDoc.id}...`);

            const expenseData = {
                date: order.orderDate,
                amount: partnerPrice,
                category: 'material',
                subCategory: 'outsource',
                description: description,
                supplier: order.outsourceInfo.partnerName || "미지정 파트너",
                quantity: totalQuantity,
                unitPrice: totalQuantity > 0 ? partnerPrice / totalQuantity : partnerPrice,
                branchId: order.branchId,
                branchName: order.branchName,
                isAutoGenerated: true,
                createdAt: admin.firestore.FieldValue.serverTimestamp(),
                updatedAt: admin.firestore.FieldValue.serverTimestamp()
            };

            await db.collection('simpleExpenses').add(expenseData);
            addedCount++;
        } else {
            // To be more precise, we should check date match or something, 
            // but for now description might be enough for a quick sync
            // unless multiple orders have exact same items.
        }
    }

    console.log(`Successfully registered ${addedCount} new expenses.`);
}

syncOutsourceToExpenses().catch(console.error);
